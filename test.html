<html>
<body>

<div align="center">
<h1 style="font-family:Arial">MAKIGAME 2.0</h1>
<canvas id="canid" width="800" height="477" style="border:3px solid black;">
</canvas>
</div>

<script>
//todo: player model, "turning", "3d" player movement+collisions and object transitions+animation, optimz slova, spawn densitiy/limit

//GLOBALS, START
var canvas=document.getElementById("canid"),
	
	W=canvas.width, H=canvas.height, HeaderH=27,
	UP=38, DOWN=40, LEFT=37, RIGHT=39,

	Keys={};
addEventListener("keydown",
                 function(e){Keys[e.keyCode]=true}
                 ,false);
addEventListener("keyup",
                 function(e){Keys[e.keyCode]=false}
                 ,false);

var Drawing=canvas.getContext("2d"),

	Objects=new objectManager(),
	Spawner=new spawner(),
	Game=new gameStuff();
	
Game.start();

//GAME LOOP
function gameLoop(){
	if (Game.getCounter()>=10) Game.stop();
	
	Objects.moveAll();	
	if ( Game.canSpawn() ) Spawner.spawnRandom(1);	
	Game.addToCounter( Objects.checkCollisions() );
	
	Game.drawBG(false);	
	Objects.drawAll();
}

//GAME CLASS
function gameStuff(){
	var starttime=then=Date.now(),
		interval, spawnFlag=false,
		collisionCounter=spawnCounter=0,
                
                collisionCounterOld=collisionCounter,
                spawnCounterOld=spawnCounter,
                secondsOld=0;
        
	Drawing.font="17px Arial";
	
	this.start=function(){
		collisionCounter+=Objects.checkCollisions();
		this.drawBG(true);
		Objects.drawAll();
		
		interval=setInterval(gameLoop, 1);
	}
	this.restart=function(){
		if (collisionCounter<10) return;
		
		starttime=then=Date.now();
		collisionCounter=spawnCounter=0;
		spawnFlag=false;
		
		Objects=new objectManager();
		collisionCounter+=Objects.checkCollisions();
		this.drawBG(false);
		Objects.drawAll();
		interval=setInterval(gameLoop, 1);
	}
	this.stop=function(){ clearInterval(interval) }
	this.getCounter=function(){ return Math.floor(collisionCounter) }
	this.addToCounter=function(c){ collisionCounter+=c }
	this.spawned=function(num){ spawnCounter+=num }
	this.despawned=function(num){ spawnCounter-=num }
	
	this.canSpawn=function(){
		if (spawnCounter>=30) return false;
		
		var seconds=Math.floor( (Date.now()-starttime)/1000 ),
			spawnInterval=3;
		if (seconds%spawnInterval===0 && seconds>0)
			if(!spawnFlag){
				spawnFlag=true;
				return true;
			}else return false;
		else{
			spawnFlag=false;
			return false;
		}
	}	
	this.getDeltaTime=function(){
		var now=Date.now(),
                    delta=now-then;
		then=now;
		return delta;
	}
	this.drawBG=function(isFirst){
		if (isFirst){
			Drawing.fillStyle="#CC6633";
			Drawing.fillRect(0,0,W,25);
			Drawing.fillStyle="black";
			Drawing.fillRect(0,25,W,2);
			
			Drawing.textAlign="left";
			Drawing.fillText("Lives: "+
				(collisionCounter>0 ? "0"+(10-collisionCounter) : 10-collisionCounter)+
				"     Enemies: "+spawnCounter,4,18);
				
			var time=Date.now()-starttime,
				minutes=Math.floor( (time/1000)/60 ),
				seconds=Math.floor( (time/1000) )%60;
			Drawing.textAlign="right";
			Drawing.fillText("Time elapsed: "+
				( minutes<10 ? "0"+minutes : minutes )+":"+( seconds<10 ? "0"+seconds : seconds ),
				W-4,18);		
		}
		if ( collisionCounter!==collisionCounterOld ){
                        collisionCounterOld=collisionCounter;
                
			Drawing.fillStyle="#CC6633";
			Drawing.fillRect(51,6,21,12);
			
			Drawing.fillStyle="black";
			Drawing.textAlign="left";
			Drawing.fillText( (collisionCounter>0 ? "0"+(10-collisionCounter) : 10-collisionCounter),
                                51,18);
		}
		if ( spawnCounter!==spawnCounterOld ){
                        spawnCounterOld=spawnCounter;
                    
			Drawing.fillStyle="#CC6633";
			Drawing.fillRect(167,6,29,12);
			
			Drawing.fillStyle="black";
			Drawing.textAlign="left";
			Drawing.fillText(spawnCounter,167,18);
		}

                var time=Date.now()-starttime,
                        minutes=Math.floor( (time/1000)/60 ),
                        seconds=Math.floor( (time/1000) )%60;
                if (minutes>=60) minutes=seconds=59;
		if ( seconds!==secondsOld ){
                        secondsOld=seconds;
                    
			Drawing.fillStyle="#CC6633";
			Drawing.fillRect(754,6,42,12);
                        
                        Drawing.fillStyle="black";
			Drawing.textAlign="right";
			Drawing.fillText( ( minutes<10 ? "0"+minutes : minutes )+":"+( seconds<10 ? "0"+seconds : seconds ),
				W-4,18);
		}
		
		Drawing.fillStyle="#FFCC99";
		Drawing.fillRect(0,27,W,H-22);
	}
}

//SPAWNER CLASS
function spawner(){
	var spawnSquareOrCircle=function(isSquare, isCircle){
		var x, y, w, h, color, vx, vy;
		
		switch ( Math.floor(Math.random()*6) ){
			case 0:
				w=h=40;
				color="blue";
				vx=-0.085-0.03*Math.random();
				break;
			case 1:
			case 2:
				w=h=30;
				color="red";
				vx=-0.17-0.06*Math.random();
				break;
			case 3:
			case 4:
			case 5:
				w=h=20;
				color="green";
				vx=-0.3-0.1*Math.random();
		}
		x=W;
		y=HeaderH+(H-HeaderH-h)*Math.random();
		vy=0;
		
		if (isSquare) Objects.add( new bRect(x, y, w, h, color, vx, vy) );
		if (isCircle) Objects.add( new bCircle(x+w/2, y+w/2, w/2, color, vx, vy) );
	}
	
	this.spawnSquare=function(num){
		for (var i=0; i<num; i++)
			spawnSquareOrCircle(true, false);
		Game.spawned(num);
	}
	this.spawnCircle=function(num){
		for (var i=0; i<num; i++)
			spawnSquareOrCircle(false, true);
		Game.spawned(num);
	}
	this.spawnRandom=function(num){
		for (var i=0; i<num; i++){
			var flag=Math.floor(Math.random()*2);
			spawnSquareOrCircle(flag, !flag);
		}
		Game.spawned(num);
	}
}

//RECT CLASS
function bRect(x, y, w, h, color, vx, vy){
	var x=x, y=y,
		w=w, h=h, color=color,
		vx=vx, vy=vy;
	this.collided=false;
	
	this.getSides=function(){ return {left:x, top:y, right:x+w, bottom:y+h} }
	this.getColor=function(){ return color }
	
	this.move=function(diff){
		x+=vx*diff;
		y+=vy*diff;
		
		var out=false;
		if (x<-w && vx<0) out=true;
		if (y<HeaderH || y+h>H){
			y+= vy<0 ? 2*(HeaderH-y) : -2*(y+h-H);
			vy=-vy;
		}
		
		return out;
	}
	this.draw=function(){
		var temp=Drawing.fillStyle;
		Drawing.fillStyle=color;
		Drawing.fillRect(x,y,w,h);
		Drawing.fillStyle=temp;
	}
}

//CIRCLE CLASS
function bCircle(x, y, r, color, vx, vy){
	var x=x, y=y,
		r=r, color=color,
		vx=vx, vy=vy;
	this.collided=false;
	
	this.getSides=function(){
		var aprox=0.8;
		return {left:x-r*aprox, top:y-r*aprox, right:x+r*aprox, bottom:y+r*aprox};
	}
	this.getColor=function(){ return color }
	
	this.move=function(diff){
		x+=vx*diff;
		y+=vy*diff;
		
		var out=false;
		if (x<-r && vx<0) out=true;
		if (y<HeaderH+r || y+r>H){
			y+= vy<0 ? 2*(HeaderH+r-y) : -2*(y+r-H);
			vy=-vy;
		}
		
		return out;
	}
	this.draw=function(){
		var temp=Drawing.fillStyle;
		Drawing.fillStyle=color;
		Drawing.beginPath();
		Drawing.arc(x,y,r,0,Math.PI*2,true);
		Drawing.closePath();
		Drawing.fill();
		Drawing.fillStyle=temp;
	}
}

//PLAYER CLASS
function player(){
	var x=W/5-18, y=Math.floor( HeaderH+(H-HeaderH)/2-13 ),
		originalX=x, originalY=y,
		w=36, h=26, color="gray",
		v=0.2;
	this.isHit=false;
	
	this.getSides=function(){ return {left:x, top:y, right:x+w, bottom:y+h} }
	
	this.move=function(diff){
		if (Keys[UP] && !Keys[DOWN]){
			y-=v*diff;
			if (y<HeaderH) y=HeaderH;
		}
		if (Keys[DOWN] && !Keys[UP]){
			y+=v*diff;
			if (y+h>H) y=H-h;
		}
		if (Keys[LEFT] && !Keys[RIGHT]){
			x-=v*diff;
			if (x<0) x=0;
		}
		if (Keys[RIGHT] && !Keys[LEFT]){
			x+=v*diff;
			if (x+w>W) x=W-w;
		}
	}
	this.draw=function(){
		var temp=Drawing.fillStyle;
		if (this.isHit) Drawing.fillStyle="#FFCC00";
		else Drawing.fillStyle=color;
		Drawing.fillRect(x,y,w,h);
		Drawing.fillStyle=temp;
	}
}

//OBJECT MANAGER CLASS
function objectManager(){
	
	var Player=new player(),
		blue=[],
		red=[],
		green=[],
		all={ blue:blue, red:red, green:green };
	
	this.add=function(obj){
		all[ obj.getColor() ].push(obj);
	}
	this.moveAll=function(){
		var num=0,
			diff=Game.getDeltaTime();
		for (var i in all)
			for (var j in all[i])
				if ( all[i][j].move(diff) ){
					all[i].splice(j,1);
					num++;
				}
		Player.move(diff);
		if (num){
			Game.despawned(num);
			Spawner.spawnRandom(num);
		}
	}
	this.drawAll=function(){
		for (var i in blue) blue[i].draw();
		for (var i in red) red[i].draw();
		for (var i in green) green[i].draw();
		Player.draw();
	}
	this.checkCollisions=function(){
		var sum=0, playerHit=false,
			pSides=Player.getSides(),
			other;
		for (var i in all)
			for (var j in all[i]){
				other=all[i][j].getSides();
				if ( other.left<pSides.right && other.top<pSides.bottom && other.right>pSides.left && other.bottom>pSides.top ){
						if (!all[i][j].collided){
							all[i][j].collided=true;
							sum++;						
						}
						playerHit=true;
				}else if (all[i][j].collided) all[i][j].collided=false;
			}
		Player.isHit=playerHit;
		return sum;
	}
}

</script>
</body>
</html>