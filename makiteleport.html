<html>
<body>

<div align="center">
<canvas id="canid" width="800" height="477" style="border:3px solid black;">
</canvas>
</div>

<script>
//todo: hit notice, removing objects, ..., actual game omg

//GLOBALS, START
var canvas=document.getElementById("canid"),
	
	W=canvas.width, H=canvas.height, HeaderH=27,
	UP=38, DOWN=40, LEFT=37, RIGHT=39,

	Keys={};
addEventListener("keydown",
                 function(e){Keys[e.keyCode]=true}
                 ,false);
addEventListener("keyup",
                 function(e){Keys[e.keyCode]=false}
                 ,false);

var Drawing=canvas.getContext("2d"),

	Objects=new objectManager(),
	Spawner=new spawner(),
	Game=new gameStuff();
	
Game.start();

//GAME LOOP
function gameLoop(){
	if (Game.getCounter()>=10) Game.stop();
	
	Objects.moveAll();	
	if ( Game.canSpawn() ) Spawner.spawnRandom(2);	
	Game.addToCounter( Objects.checkCollisions() );
	
	Game.drawBG();	
	Objects.drawAll();
}

//GAME CLASS
function gameStuff(){
	var starttime, then, interval,
		collisionCounter, spawnCounter, spawnFlag;
	
	this.start=function(){
		starttime=then=Date.now();
		collisionCounter=spawnCounter=0;
		spawnFlag=false;
		
		collisionCounter+=Objects.checkCollisions();
		this.drawBG();
		Objects.drawAll();
		interval=setInterval(gameLoop, 1);
	}
	this.stop=function(){ clearInterval(interval) }
	this.getCounter=function(){ return Math.floor(collisionCounter) }
	this.addToCounter=function(c){ collisionCounter+=c }
	this.oneSpawned=function(){ spawnCounter++ }
	
	this.canSpawn=function(){ 
		var seconds=Math.floor( (Date.now()-starttime)/1000 );
		if (seconds%5==0 && seconds>0)
			if(!spawnFlag){
				spawnFlag=true;
				return true;
			}else return false;
		else{
			spawnFlag=false;
			return false;
		}
	}	
	this.getDeltaTime=function(){
		var now=Date.now()
		var delta=now-then;
		then=now;
		return delta;
	}
	this.drawBG=function(){
		Drawing.fillStyle="#CC6633";
		Drawing.fillRect(0,0,W,25);	
		Drawing.fillStyle="#FFCC99";
		Drawing.fillRect(0,27,W,H-22);
		Drawing.fillStyle="black";
		Drawing.fillRect(0,25,W,2);
		
		Drawing.font="17px Arial";
		Drawing.textAlign="left";
		Drawing.fillText("Lives: "+
			(collisionCounter>0 ? "0"+(10-collisionCounter) : 10-collisionCounter)+
			"     Spawned: "+spawnCounter,4,18);
			
		var time=Date.now()-starttime,
			minutes=Math.floor( (time/1000)/60 ),
			seconds=Math.floor( (time/1000) )%60;
			if (minutes>=60) minutes=seconds=59;
		Drawing.textAlign="right";
		Drawing.fillText("Time elapsed: "+
			( minutes<10 ? "0"+minutes : minutes )+":"+( seconds<10 ? "0"+seconds : seconds ),
			W-4,18);
	}
}

//SPAWNER CLASS
function spawner(){
	var spawnSquareOrCircle=function(isSquare, isCircle){
		var x, y, w, h, color, vx, vy;
		switch ( Math.floor(Math.random()*3) ){
			case 0:
				w=h=40;
				color="blue";
				vx=0.2//*Math.random();
				vy=0.36-vx;
				break;
			case 1:
				w=h=30;
				color="red";
				vx=0.4//*Math.random();
				vy=0.5-vx;
				break;
			case 2:
				w=h=20;
				color="green";
				vx=0.8//*Math.random();
				vy=0.64-vx;
		}
		/*switch ( Math.floor(Math.random()*4) ){
			case 0:
				x=0;
				y=HeaderH;
				break;
			case 1:
				x=W-w;
				y=HeaderH;
				vx=-vx;
				break;
			case 2:
				x=0;
				y=H-h;
				vy=-vy;
				break;
			case 3:
				x=W-w;
				y=H-h;
				vx=-vx;
				vy=-vy;
		}*/
		x=W;
		y=HeaderH+(H-HeaderH-h)*Math.random();
		vx=-vx;
		vy=0;
		
		if (isSquare) Objects.add( new bRect(x, y, w, h, color, vx, vy) );
		if (isCircle) Objects.add( new bCircle(x+w/2, y+w/2, w/2, color, vx, vy) );
		Game.oneSpawned();
	}
	
	this.spawnSquare=function(){ spawnSquareOrCircle(true, false) }
	this.spawnCircle=function(){ spawnSquareOrCircle(false, true) }
	this.spawnRandom=function(num){
		for (var i=0; i<num; i++){
			var flag=Math.floor(Math.random()*2);
			spawnSquareOrCircle(flag, !flag);
		}
	}
}

//RECT CLASS
function bRect(x, y, w, h, color, vx, vy){
	var x=x, y=y,
		w=w, h=h, color=color,
		vx=vx, vy=vy;
	this.collided=false;
	
	this.getDimensions=function(){ return {left:x, top:y, right:x+w, bottom:y+h} }
	this.getColor=function(){ return color }
	this.isPlayer=function(){ return false }
	
	this.move=function(diff){
		x+=vx*diff;
		y+=vy*diff;
		
		/*if (x<0 || x+w>W){
			x+= vx<0 ? 2*-x : -2*(x+w-W);
			vx=-vx;
		}*/
		if (x<-w) x+=2*w+W;
		if (y<HeaderH || y+h>H){
			y+= vy<0 ? 2*(HeaderH-y) : -2*(y+h-H);
			vy=-vy;
		}
	}
	this.draw=function(){
		var temp=Drawing.fillStyle;
		Drawing.fillStyle=color;
		Drawing.fillRect(x,y,w,h);
		Drawing.fillStyle=temp;
	}
}

//CIRCLE CLASS
function bCircle(x, y, r, color, vx, vy){
	var x=x, y=y,
		r=r, color=color,
		vx=vx, vy=vy;
	this.collided=false;
	
	this.getDimensions=function(){
		var aprox=0.8;
		return {left:x-r*aprox, top:y-r*aprox, right:x+r*aprox, bottom:y+r*aprox};
	}
	this.getColor=function(){ return color }
	this.isPlayer=function(){ return false }
	
	this.move=function(diff){
		x+=vx*diff;
		y+=vy*diff;
		/*if (x<r || x+r>W){
			x+= vx<0 ? 2*(r-x) : -2*(x+r-W);
			vx=-vx;
		}*/
		if (x<-r) x+=4*r+W;
		if (y<HeaderH+r || y+r>H){
			y+= vy<0 ? 2*(HeaderH+r-y) : -2*(y+r-H);
			vy=-vy;
		}
	}
	this.draw=function(){
		var temp=Drawing.fillStyle;
		Drawing.fillStyle=color;
		Drawing.beginPath();
		Drawing.arc(x,y,r,0,Math.PI*2,true);
		Drawing.closePath();
		Drawing.fill();
		Drawing.fillStyle=temp;
	}
}

//PLAYER CLASS
function player(){
	var x=W/2-20, y=Math.floor( HeaderH+(H-HeaderH)/2-15 ),
		w=40, h=30, color="gray",
		v=0.3;
	
	this.getDimensions=function(){ return {left:x, top:y, right:x+w, bottom:y+h} }
	this.isPlayer=function(){ return true }
	
	this.move=function(diff){
		if (Keys[UP] && !Keys[DOWN]){
			y-=v*diff;
			if (y<HeaderH) y=HeaderH;
		}
		if (Keys[DOWN] && !Keys[UP]){
			y+=v*diff;
			if (y+h>H) y=H-h;
		}
		if (Keys[LEFT] && !Keys[RIGHT]){
			x-=v*diff;
			if (x<0) x=0;
		}
		if (Keys[RIGHT] && !Keys[LEFT]){
			x+=v*diff;
			if (x+w>W) x=W-w;
		}
	}
	this.draw=function(){
		var temp=Drawing.fillStyle;
		Drawing.fillStyle=color;
		Drawing.fillRect(x,y,w,h);
		Drawing.fillStyle=temp;
	}
}

//OBJECT MANAGER CLASS
function objectManager(){
	
	var Player=new player(),
		blue=[],
		red=[],
		green=[],
		all={ blue:blue, red:red, green:green };
	
	this.add=function(obj){
		all[ obj.getColor() ].push(obj);
	}
	this.moveAll=function(){
		var diff=Game.getDeltaTime();
		for (var i in all)
			for (var j in all[i]) all[i][j].move(diff);
		Player.move(diff);
	}
	this.drawAll=function(){
		for (var i in blue) blue[i].draw();
		for (var i in red) red[i].draw();
		for (var i in green) green[i].draw();
		Player.draw();
	}
	this.checkCollisions=function(){
		var sum=0;
		var pSides=Player.getDimensions(),
			other;
		for (var i in all)
			for (var j in all[i]){
				other=all[i][j].getDimensions();
				if ( other.left<pSides.right && other.top<pSides.bottom && other.right>pSides.left && other.bottom>pSides.top ){
						if (!all[i][j].collided){
							all[i][j].collided=true;
							sum++;
							all[i].splice(j,1);
						}
				}else if (all[i][j].collided) all[i][j].collided=false;
			}
		return sum;
	}
}

</script>
</body>
</html>